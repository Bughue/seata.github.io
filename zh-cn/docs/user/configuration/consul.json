{
  "filename": "consul.md",
  "__html": "<h1>Consul 配置中心</h1>\n<p>在 <a href=\"http://seata.io/zh-cn/docs/user/registry/consul.html\">以 Consul 作为注册中心</a> 的基础上，将 Seata 配置放到 Consul 中</p>\n<p>本文基于 Seata 1.4.2，Consul 版本建议 1.8+，下文以 Consul 1.11.2 为例</p>\n<h2>准备工作</h2>\n<p>当您决定使用 Consul 作为 Seata 配置中心前，请确保已经启动 Consul 服务。</p>\n<h2>快速上手</h2>\n<p>将 Consul 作为 Seata 配置中心的操作步骤非常简单，可分为以下几步：</p>\n<ol>\n<li>seata-server 配置 Consul 为配置中心</li>\n<li>提交 Key-Value 配置至 Consul</li>\n<li>Client 端 配置 Consul 为配置中心</li>\n</ol>\n<h3>配置 Consul 为配置中心</h3>\n<p>首先，请确保您的 Consul 服务已启动</p>\n<p>在 Seata 目录下 /conf/registry.conf\n中加入对应配置中心,其余<a href=\"https://github.com/seata/seata/blob/1.4.2/script/server/config/registry.conf\">配置参考</a></p>\n<pre><code>config {\n  type = &quot;consul&quot;\n\n  consul {\n    serverAddr = &quot;127.0.0.1:8500&quot;\n    aclToken = &quot;&quot;\n  }\n}\n</code></pre>\n<p><strong>此时启动 Seata 服务，会提示如下字样信息，可先关闭服务</strong></p>\n<pre><code>config operation timeout,cost:5015 ms,op:GET,dataId:store.mode\nconfig operation timeout,cost:5006 ms,op:GET,dataId:metrics.enabled\nconfig operation timeout,cost:5001 ms,op:GET,dataId:transport.threadFactory.bossThreadPrefix\nconfig operation timeout,cost:5009 ms,op:GET,dataId:transport.threadFactory.workerThreadPrefix\n# 此处省略类似的其他信息~\n</code></pre>\n<h3>提交 Key-Value 配置至 Consul</h3>\n<p>出现以上报错信息是因为 Consul 中缺少对应配置，请从以下方式中<strong>选择其中一种方式</strong>提交配置到 Consul Key/Value 中</p>\n<ol>\n<li>通过 Consul 控制台 ui，Key/Value -&gt; create</li>\n<li>通过 <a href=\"https://www.consul.io/api-docs/kv\">http 请求</a></li>\n<li>通过 <a href=\"https://www.consul.io/commands/kv\">Consul 命令行工具</a></li>\n<li><strong>推荐：使用官方提供的上传配置脚本</strong></li>\n</ol>\n<p><strong>tips</strong>: 1.4.2 需要逐个创建 key-value，1.5.0 后支持 key 对应文件</p>\n<p>以 store.mode=file\n为例，提交报错信息对应的配置，在这里可以找到<a href=\"https://github.com/seata/seata/blob/1.4.2/script/config-center/config.txt\">默认配置</a></p>\n<pre><code class=\"language-properties\"><span class=\"hljs-meta\">store.mode</span>=<span class=\"hljs-string\">file</span>\n<span class=\"hljs-meta\">store.publicKey</span>=<span class=\"hljs-string\"></span>\n<span class=\"hljs-meta\">store.file.dir</span>=<span class=\"hljs-string\">file_store/data</span>\n<span class=\"hljs-meta\">store.file.maxBranchSessionSize</span>=<span class=\"hljs-string\">16384</span>\n<span class=\"hljs-comment\"># 剩下的配置项省略~</span>\n</code></pre>\n<p><strong>推荐使用官方脚本：</strong> 以上方式 1~3 需要逐个添加配置，操作较为繁琐，为此官方提供了\n<a href=\"https://github.com/seata/seata/blob/1.4.2/script/config-center/consul/consul-config.sh\">脚本</a> 和\n<a href=\"https://github.com/seata/seata/blob/1.4.2/script/config-center/config.txt\">默认配置</a>\n以快速添加配置</p>\n<p>将 config.txt 放在 <a href=\"http://consul-config.sh\">consul-config.sh</a> 的<strong>上层目录</strong>， 根据自己的需要微调 config.txt 的配置（主要是 seata.mode 及 seata.file | seata.db | seata.redis\n这几个前缀的配置）</p>\n<p>执行如下命令</p>\n<pre><code class=\"language-shell\">sh {PATH}/consul-config.sh -h localhost -p 8500\n</code></pre>\n<p>具体操作可参考<a href=\"https://github.com/seata/seata/blob/1.4.2/script/config-center/README.md\">README.md</a></p>\n<p>此时重启 Seata 服务，发现不再报错，即成功使用 Consul 作为配置中心了，后面如需调整配置，可前往控制台单独修改对应的配置，修改后需重启服务</p>\n<h3>Client 端 配置 Consul 为配置中心</h3>\n<p><strong>以 SpringBoot 项目为例，在项目 pom.xml 中加入</strong></p>\n<pre><code class=\"language-xml\">\n<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">dependency</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">groupId</span>&gt;</span>io.seata<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">groupId</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">artifactId</span>&gt;</span>seata-spring-boot-starter<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">artifactId</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">version</span>&gt;</span>最新版（Seata版本）<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">version</span>&gt;</span>\n<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">dependency</span>&gt;</span>\n<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">dependency</span>&gt;</span>\n<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">groupId</span>&gt;</span>org.springframework.cloud<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">groupId</span>&gt;</span>\n<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">artifactId</span>&gt;</span>spring-cloud-starter-consul-config<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">artifactId</span>&gt;</span>\n<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">dependency</span>&gt;</span>\n</code></pre>\n<h3>Client端配置</h3>\n<p>在 application.yml 中加入对应的配置中心，其余<a href=\"https://github.com/seata/seata/blob/develop/script/client/spring/application.yml\">配置参考</a></p>\n<pre><code class=\"language-yaml\"><span class=\"hljs-attr\">seata:</span>\n<span class=\"hljs-attr\">  config:</span>\n<span class=\"hljs-attr\">    type:</span> <span class=\"hljs-string\">consul</span>\n<span class=\"hljs-attr\">    consul:</span>\n<span class=\"hljs-attr\">      server-addr:</span> <span class=\"hljs-number\">127.0</span><span class=\"hljs-number\">.0</span><span class=\"hljs-number\">.1</span><span class=\"hljs-string\">:8500</span>\n</code></pre>\n<p>重启 Client 即可</p>\n",
  "link": "/zh-cn/docs/user/configuration/consul.html",
  "meta": {}
}